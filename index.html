<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geography Master Quiz</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #0f172a;
            color: #f8fafc;
            overflow: hidden;
            height: 100dvh;
        }
        button {
            touch-action: manipulation;
        }
        #map-container svg {
            touch-action: none;
        }
        #map-container {
            background: radial-gradient(circle at center, #1e293b 0%, #0f172a 100%);
            border-radius: 1rem;
        }
        .country {
            stroke-width: 0.5px;
            transition: fill 0.3s ease, stroke 0.3s ease;
            outline: none;
            /* Using different colors for fill and stroke for visibility */
            fill: #1e293b; 
            stroke: #334155;
        }
        .country-excluded {
            fill: #0f172a;
            opacity: 0.4;
            pointer-events: none;
        }
        .country-highlight {
            fill: #fbbf24 !important; /* Amber 400 */
            stroke: none !important;
        }
        .btn-option {
            background: #1e293b;
            border: 1px solid #475569;
            transition: all 0.2s ease;
        }
        .btn-option:hover {
            background: #334155;
            border-color: #64748b;
        }
        .btn-option.correct {
            background: #166534 !important;
            border-color: #22c55e !important;
        }
        .btn-option.wrong {
            background: #7f1d1d !important;
            border-color: #ef4444 !important;
        }
        .zoom-controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        .btn-zoom {
            background: rgba(30, 41, 59, 0.8);
            border: 1px solid #475569;
            color: white;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            backdrop-filter: blur(4px);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }
        #loader {
            position: absolute;
            inset: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #0f172a;
            z-index: 100;
        }
        .settings-modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.8);
            z-index: 200;
            align-items: center;
            justify-content: center;
        }
        .mode-btn-active {
            background-color: #2563eb !important;
            border-color: #3b82f6 !important;
        }
    </style>
</head>
<body class="flex flex-col items-center p-2 sm:p-4">

    <div id="loader">
        <div class="flex flex-col items-center gap-4">
            <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
            <p class="text-blue-400 font-medium">Loading Geography Quiz...</p>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="settings-modal p-4">
        <div class="bg-slate-800 border border-slate-700 w-full max-w-2xl rounded-2xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">Quiz Settings</h2>
                <button onclick="toggleSettings()" class="text-slate-400 hover:text-white">✕</button>
            </div>
            
            <div class="mb-6">
                <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-widest mb-4">Game Mode</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button id="mode-hard" onclick="setMode('hard')" class="p-3 bg-slate-700 border border-slate-600 rounded-xl font-bold text-sm transition-all mode-btn-active">Hard Mode (Type)</button>
                    <button id="mode-easy" onclick="setMode('easy')" class="p-3 bg-slate-700 border border-slate-600 rounded-xl font-bold text-sm transition-all">Easy Mode (Choices)</button>
                </div>
            </div>

            <div class="mb-6">
                <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-widest mb-4">Map Display</h3>
                <label class="flex items-center gap-3 p-3 bg-slate-700/50 rounded-xl cursor-pointer hover:bg-slate-700 transition-colors">
                    <input type="checkbox" id="check-borders" checked 
                           class="w-5 h-5 rounded border-slate-600 bg-slate-800 text-blue-500 focus:ring-blue-500">
                    <span class="text-sm font-medium text-slate-200">Show Country Borders</span>
                </label>
            </div>

            <div class="mb-6">
                <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-widest mb-4">Continents & Regions</h3>
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-3" id="region-toggles">
                    <!-- Toggles will be injected here -->
                </div>
            </div>

            <div class="flex justify-end pt-4 border-t border-slate-700">
                <button onclick="applySettings()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-bold transition-all">Apply & Restart</button>
            </div>
        </div>
    </div>

    <!-- Header UI -->
    <div class="w-full max-w-5xl flex items-center justify-between gap-2 mb-1">
        <div class="flex items-center gap-2">
            <h1 class="text-sm font-bold text-blue-400 hidden sm:block">Geography Challenge</h1>
            <span class="text-xs font-mono text-slate-400"><span id="score" class="font-bold text-green-400">0</span>✓ <span id="wrong-count" class="font-bold text-red-400">0</span>✗ <span id="remaining" class="font-bold text-blue-400">0</span> left</span>
        </div>
        <div class="flex items-center gap-1">
            <button onclick="resetGame()" class="text-xs bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded-lg font-bold transition-all">↺</button>
            <button onclick="toggleSettings()" class="text-xs bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded-lg border border-slate-600 text-slate-300 transition-colors">⚙️</button>
        </div>
    </div>
    <p id="active-regions-label" class="hidden text-slate-400 text-xs"></p>

    <!-- Map Canvas -->
    <div id="map-container" class="relative w-full max-w-5xl flex-1 min-h-0 border border-slate-700 shadow-2xl overflow-hidden">
        <div id="country-overlay" class="absolute inset-0 flex items-center justify-center pointer-events-none z-10 hidden">
            <div id="country-name-display" class="text-3xl sm:text-4xl font-bold px-6 py-3 rounded-xl bg-black/50 backdrop-blur-sm"></div>
        </div>
        <div class="zoom-controls">
            <button class="btn-zoom" onclick="zoomIn()">+</button>
            <button class="btn-zoom" onclick="zoomOut()">-</button>
            <button class="btn-zoom" onclick="resetZoom()">⟲</button>
        </div>
    </div>

    <!-- Interaction Area -->
    <div class="w-full max-w-5xl mt-1">
        <div id="input-area" class="w-full relative">
            <input type="text" id="answer-input" placeholder=""
                   class="w-full bg-slate-800 border-2 border-slate-700 focus:border-blue-500 rounded-xl px-3 py-2 pr-16 text-sm sm:text-base font-bold text-white outline-none transition-all"
                   autocomplete="off" autocapitalize="none" autocorrect="off" spellcheck="false">
            <button onclick="showHint()" id="hint-btn" class="absolute right-2 top-1/2 -translate-y-1/2 text-xs bg-amber-600/20 text-amber-400 border border-amber-600/40 hover:bg-amber-600/40 px-2 py-1 rounded-lg font-bold transition-all">Hint</button>
        </div>
        
        <!-- Options Container (hidden by default, shown on hint or in Easy Mode) -->
        <div id="options-grid" class="hidden w-full grid grid-cols-2 md:grid-cols-4 gap-3 mt-4">
            <!-- Hint buttons injected here -->
        </div>
    </div>

    <script>
        const container = document.getElementById('map-container');
        const optionsGrid = document.getElementById('options-grid');
        const inputArea = document.getElementById('input-area');
        const answerInput = document.getElementById('answer-input');
        const settingsModal = document.getElementById('settings-modal');

        let width = container.clientWidth;
        let height = container.clientHeight;

        let score = 0;
        let wrongCount = 0;
        let pool = [];
        let fullDataset = [];
        let currentTarget = null;
        let canAnswer = false;
        let showBorders = true;
        let gameMode = 'easy';

        // Colors
        const COLOR_ACTIVE_FILL = "#1e293b";
        const COLOR_BORDER = "#475569"; // Lighter slate for visible borders
        const COLOR_EXCLUDED_FILL = "#0f172a";

        // Default Regions
        const regions = [
            { id: 'north-america', label: 'North America', active: true },
            { id: 'south-america', label: 'South America', active: true },
            { id: 'europe', label: 'Europe', active: true },
            { id: 'asia', label: 'Asia', active: true },
            { id: 'africa-north', label: 'Africa: Above Equator', active: true },
            { id: 'africa-south', label: 'Africa: Below Equator', active: false },
            { id: 'oceania', label: 'Oceania', active: false }
        ];

        const svg = d3.select("#map-container")
            .append("svg")
            .attr("width", "100%")
            .attr("height", "100%")
            .attr("viewBox", `0 0 ${width} ${height}`);

        const g = svg.append("g");

        const projection = d3.geoMercator()
            .scale(width / 6.5)
            .translate([width / 2, height / 1.5]);

        const path = d3.geoPath().projection(projection);

        const zoom = d3.zoom()
            .scaleExtent([1, 100])
            .on("zoom", (event) => {
                g.attr("transform", event.transform);
                g.selectAll(".country").style("stroke-width", 0.5 / event.transform.k + "px");
            });

        svg.call(zoom);

        function getCountryName(feature) {
            if (!feature) return "Unknown";
            const p = feature.properties;
            return p.NAME || p.ADMIN || p.name || "Unnamed Territory";
        }

        function levenshteinDistance(s1, s2) {
            const m = s1.length;
            const n = s2.length;
            const d = Array.from({ length: m + 1 }, () => new Array(n + 1).fill(0));
            for (let i = 0; i <= m; i++) d[i][0] = i;
            for (let j = 0; j <= n; j++) d[0][j] = j;
            for (let j = 1; j <= n; j++) {
                for (let i = 1; i <= m; i++) {
                    const cost = s1[i - 1] === s2[j - 1] ? 0 : 1;
                    d[i][j] = Math.min(d[i - 1][j] + 1, d[i][j - 1] + 1, d[i - 1][j - 1] + cost);
                }
            }
            return d[m][n];
        }

        function normalizeString(str) {
            return str.toLowerCase()
                .replace(/^the\s+/i, '')
                .replace(/[^a-z0-9\s]/gi, '')
                .trim();
        }

        function getCountryRegionId(feature) {
            const props = feature.properties;
            const cont = (props.CONTINENT || props.continent || "").toLowerCase();
            const centroid = d3.geoCentroid(feature);
            const lat = centroid[1];
            
            if (cont.includes("north america")) return 'north-america';
            if (cont.includes("south america")) return 'south-america';
            if (cont.includes("europe")) return 'europe';
            if (cont.includes("asia")) return 'asia';
            if (cont.includes("oceania")) return 'oceania';
            if (cont.includes("africa")) return lat >= 0 ? 'africa-north' : 'africa-south';
            return null;
        }

        function isAllowed(feature) {
            const rId = getCountryRegionId(feature);
            const r = regions.find(x => x.id === rId);
            return r ? r.active : false;
        }

        async function init() {
            try {
                const response = await fetch('https://raw.githubusercontent.com/nvkelso/natural-earth-vector/master/geojson/ne_110m_admin_0_countries.geojson');
                const data = await response.json();
                fullDataset = data.features;

                renderSettings();
                updateActiveLabel();
                applySettings(false); 

                g.selectAll("path")
                    .data(fullDataset)
                    .enter()
                    .append("path")
                    .attr("d", path)
                    .attr("class", d => isAllowed(d) ? "country" : "country country-excluded")
                    .style("stroke", showBorders ? COLOR_BORDER : "none")
                    .style("fill", d => isAllowed(d) ? COLOR_ACTIVE_FILL : COLOR_EXCLUDED_FILL);

                document.getElementById('loader').style.display = 'none';
                nextQuestion();

                answerInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') checkTypedAnswer();
                });
            } catch (err) {
                console.error("Error loading map:", err);
            }
        }

        function renderSettings() {
            const container = document.getElementById('region-toggles');
            container.innerHTML = regions.map(r => `
                <label class="flex items-center gap-3 p-3 bg-slate-700/50 rounded-xl cursor-pointer hover:bg-slate-700 transition-colors">
                    <input type="checkbox" id="check-${r.id}" ${r.active ? 'checked' : ''} 
                           class="w-5 h-5 rounded border-slate-600 bg-slate-800 text-blue-500 focus:ring-blue-500">
                    <span class="text-sm font-medium text-slate-200">${r.label}</span>
                </label>
            `).join('');
        }

        function setMode(mode) {
            gameMode = mode;
            document.getElementById('mode-hard').classList.toggle('mode-btn-active', mode === 'hard');
            document.getElementById('mode-easy').classList.toggle('mode-btn-active', mode === 'easy');
        }

        function toggleSettings() {
            settingsModal.style.display = settingsModal.style.display === 'flex' ? 'none' : 'flex';
        }

        function applySettings(startNew = true) {
            showBorders = document.getElementById('check-borders').checked;
            regions.forEach(r => {
                const cb = document.getElementById(`check-${r.id}`);
                if (cb) r.active = cb.checked;
            });

            pool = fullDataset.filter(isAllowed);
            document.getElementById('remaining').innerText = pool.length;

            g.selectAll(".country")
                .attr("class", d => isAllowed(d) ? "country" : "country country-excluded")
                .style("stroke", showBorders ? COLOR_BORDER : "none")
                .style("fill", d => isAllowed(d) ? COLOR_ACTIVE_FILL : COLOR_EXCLUDED_FILL);

            updateActiveLabel();
            toggleSettings();
            if (startNew) resetGame();
        }

        function updateActiveLabel() {
            const activeNames = regions.filter(r => r.active).map(r => r.label);
            document.getElementById('active-regions-label').innerText = activeNames.length > 0 ? activeNames.join(', ') : 'None selected';
        }

        function showOverlay(name, isCorrect) {
            const overlay = document.getElementById('country-overlay');
            const nameDisplay = document.getElementById('country-name-display');
            nameDisplay.textContent = name;
            nameDisplay.className = `text-3xl sm:text-4xl font-bold px-6 py-3 rounded-xl bg-black/50 backdrop-blur-sm ${isCorrect ? 'text-green-400' : 'text-red-400'}`;
            overlay.classList.remove('hidden');
            setTimeout(() => overlay.classList.add('hidden'), 1200);
        }

        function nextQuestion() {
            if (pool.length === 0) {
                inputArea.classList.add('hidden');
                optionsGrid.classList.remove('hidden');
                optionsGrid.innerHTML = `<button onclick="resetGame()" class="col-span-full py-4 bg-blue-600 hover:bg-blue-500 rounded-xl font-bold transition-colors">Restart Quiz</button>`;
                g.selectAll(".country").classed("country-highlight", false);
                document.getElementById('hint-btn').style.display = 'none';
                return;
            }

            canAnswer = true;

            const idx = Math.floor(Math.random() * pool.length);
            currentTarget = pool[idx];

            if (gameMode === 'hard') {
                answerInput.value = '';
                answerInput.focus();
                optionsGrid.classList.add('hidden');
                inputArea.classList.remove('hidden');
                document.getElementById('hint-btn').style.display = 'block';
            } else {
                inputArea.classList.add('hidden');
                optionsGrid.classList.remove('hidden');
                document.getElementById('hint-btn').style.display = 'none';
                generateChoices();
            }

            g.selectAll(".country").classed("country-highlight", d => d === currentTarget);

            try {
                const bounds = path.bounds(currentTarget);
                if (bounds && !isNaN(bounds[0][0])) {
                    const dx = bounds[1][0] - bounds[0][0];
                    const dy = bounds[1][1] - bounds[0][1];
                    const x = (bounds[0][0] + bounds[1][0]) / 2;
                    const y = (bounds[0][1] + bounds[1][1]) / 2;
                    const maxDim = Math.max(dx / width, dy / height, 0.001);
                    const scale = Math.max(1.8, Math.min(35, 0.42 / maxDim));
                    const translate = [width / 2 - scale * x, height / 2 - scale * y];
                    svg.transition().duration(850).call(zoom.transform, d3.zoomIdentity.translate(translate[0], translate[1]).scale(scale));
                }
            } catch (e) {}
        }

        function generateChoices() {
            const targetName = getCountryName(currentTarget);
            const options = [targetName];
            const allowedForHints = fullDataset.filter(isAllowed);
            while (options.length < 4) {
                const randomCountry = allowedForHints[Math.floor(Math.random() * allowedForHints.length)];
                const randomName = getCountryName(randomCountry);
                if (!options.includes(randomName)) options.push(randomName);
            }
            options.sort(() => Math.random() - 0.5);
            optionsGrid.innerHTML = '';
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = "btn-option p-3 rounded-xl font-semibold text-sm shadow-lg text-white";
                btn.innerText = opt;
                btn.onclick = () => {
                    if (!canAnswer) return;
                    if (opt === targetName) handleCorrect();
                    else handleWrong();
                };
                optionsGrid.appendChild(btn);
            });
        }

        function checkTypedAnswer() {
            if (!canAnswer) return;
            const guess = normalizeString(answerInput.value);
            const actual = normalizeString(getCountryName(currentTarget));
            if (guess.length < 2) return;
            if (guess === actual || (actual.includes(guess) && guess.length > 3)) {
                handleCorrect();
                return;
            }
            const distance = levenshteinDistance(guess, actual);
            const threshold = actual.length < 5 ? 1 : 2;
            if (distance <= threshold) {
                handleCorrect();
            } else {
                handleWrong();
            }
        }

        function showHint() {
            if (!canAnswer) return;
            inputArea.classList.add('hidden');
            optionsGrid.classList.remove('hidden');
            generateChoices();
        }

        function handleCorrect() {
            canAnswer = false;
            score++;
            document.getElementById('score').innerText = score;
            const targetName = getCountryName(currentTarget);
            showOverlay(targetName, true);
            pool = pool.filter(c => getCountryName(c) !== targetName);
            document.getElementById('remaining').innerText = pool.length;
            setTimeout(nextQuestion, 1200);
        }

        function handleWrong() {
            canAnswer = false;
            wrongCount++;
            document.getElementById('wrong-count').innerText = wrongCount;
            const targetName = getCountryName(currentTarget);
            showOverlay(targetName, false);
            pool = pool.filter(c => getCountryName(c) !== targetName);
            document.getElementById('remaining').innerText = pool.length;
            setTimeout(nextQuestion, 1400);
        }

        function resetGame() {
            score = 0;
            wrongCount = 0;
            document.getElementById('score').innerText = 0;
            document.getElementById('wrong-count').innerText = 0;
            pool = fullDataset.filter(isAllowed);
            document.getElementById('remaining').innerText = pool.length;
            nextQuestion();
        }

        function zoomIn() { svg.transition().duration(400).call(zoom.scaleBy, 2); }
        function zoomOut() { svg.transition().duration(400).call(zoom.scaleBy, 0.5); }
        function resetZoom() { svg.transition().duration(400).call(zoom.transform, d3.zoomIdentity); }
        window.addEventListener('resize', () => {
            width = container.clientWidth;
            height = container.clientHeight;
            svg.attr("viewBox", `0 0 ${width} ${height}`);
        });

        // Shrink layout to fit the visible area when the virtual keyboard opens
        function syncViewportHeight() {
            document.body.style.height = (window.visualViewport?.height ?? window.innerHeight) + 'px';
        }
        if (window.visualViewport) {
            window.visualViewport.addEventListener('resize', syncViewportHeight);
            syncViewportHeight();
        }

        setMode(gameMode);
        init();
    </script>
</body>
</html>
