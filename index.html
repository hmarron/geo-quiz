<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Geography Master Quiz</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <meta name="theme-color" content="#0f172a">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="GeoQuiz">
    <!-- D3.js is now loaded by the plugin -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1/dist/peerjs.min.js"></script>
    <link rel="stylesheet" href="style.css">
</head>
<body class="flex flex-col items-center p-2 sm:p-4">

    <!-- Start Screen -->
    <div id="start-screen" class="start-screen">
        <div class="flex flex-col items-center gap-6 w-full max-w-xs px-6">
            <div class="text-6xl">üåç</div>
            <div class="text-center">
                <h1 class="text-3xl font-bold text-white">Geography Challenge</h1>
                <p class="text-slate-400 mt-1 text-sm">Test your world geography knowledge</p>
            </div>
            <div class="w-full flex flex-col gap-3">
                <button onclick="startSinglePlayer()" class="w-full bg-blue-600 hover:bg-blue-500 active:bg-blue-700 text-white py-4 rounded-xl font-bold text-lg transition-colors">
                    Single Player
                </button>
                <button onclick="startMultiplayer()" class="w-full bg-slate-700 hover:bg-slate-600 active:bg-slate-800 text-white py-4 rounded-xl font-bold text-lg transition-colors border border-slate-600">
                    Multiplayer <span class="text-slate-400 font-normal text-sm">(Experimental)</span>
                </button>
            </div>
            <button onclick="toggleScores()" class="text-sm text-slate-500 hover:text-slate-300 transition-colors">
                High Scores
            </button>
            <button id="start-install-btn" onclick="installApp()" class="hidden text-xs text-slate-600 hover:text-slate-400 transition-colors">
                + Install App
            </button>
        </div>
    </div>

    <div id="loader">
        <div class="flex flex-col items-center gap-4">
            <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin"></div>
            <p id="loader-text" class="text-blue-400 font-medium">Loading Quiz...</p>
        </div>
    </div>

    <!-- Scores Modal -->
    <div id="scores-modal" class="scores-modal p-4">
        <div class="bg-slate-800 border border-slate-700 w-full max-w-lg rounded-2xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-white">High Scores</h2>
                <button onclick="toggleScores()" class="text-slate-400 hover:text-white">‚úï</button>
            </div>
            <div id="scores-list" class="flex flex-col gap-2"></div>
        </div>
    </div>

    <!-- Finish Modal -->
    <div id="finish-modal" class="finish-modal p-4">
        <div class="bg-slate-800 border border-slate-700 rounded-2xl p-8 w-full max-w-sm shadow-2xl text-center">
            <div class="text-5xl mb-3">üèÜ</div>
            <h2 class="text-2xl font-bold text-white mb-6">Quiz Complete!</h2>
            <div class="grid grid-cols-3 gap-4 mb-4">
                <div class="bg-slate-700/50 rounded-xl p-3">
                    <div id="final-score" class="text-2xl font-bold text-green-400">0</div>
                    <div class="text-xs text-slate-400 uppercase tracking-wide mt-1">Correct</div>
                </div>
                <div class="bg-slate-700/50 rounded-xl p-3">
                    <div id="final-wrong" class="text-2xl font-bold text-red-400">0</div>
                    <div class="text-xs text-slate-400 uppercase tracking-wide mt-1">Wrong</div>
                </div>
                <div class="bg-slate-700/50 rounded-xl p-3">
                    <div id="final-time" class="text-2xl font-bold text-blue-400">0:00</div>
                    <div class="text-xs text-slate-400 uppercase tracking-wide mt-1">Time</div>
                </div>
            </div>
            <div class="text-sm text-slate-400 mt-1" id="final-accuracy"></div>
            <div class="text-xs text-amber-400 mt-1 mb-6" id="final-best"></div>
            <button onclick="playAgain()" class="w-full bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl font-bold transition-colors">Play Again</button>
            <div class="grid grid-cols-2 gap-3 mt-3">
                <button onclick="goHome()" class="bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-xl font-bold transition-colors">Home</button>
                <button onclick="showFinishThenScores()" class="bg-slate-700 hover:bg-slate-600 text-white py-3 rounded-xl font-bold transition-colors">High Scores</button>
            </div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="settings-modal p-4">
        <div class="bg-slate-800 border border-slate-700 w-full max-w-2xl rounded-2xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-white">Quiz Settings</h2>
                <button onclick="toggleSettings()" class="text-slate-400 hover:text-white">‚úï</button>
            </div>

            <div class="mb-6">
                <h3 class="text-sm font-semibold text-slate-400 uppercase tracking-widest mb-4">Game Mode</h3>
                <div class="grid grid-cols-2 gap-3">
                    <button id="mode-hard" onclick="setMode('hard')" class="p-3 bg-slate-700 border border-slate-600 rounded-xl font-bold text-sm transition-all">Hard Mode (Type)</button>
                    <button id="mode-easy" onclick="setMode('easy')" class="p-3 bg-slate-700 border border-slate-600 rounded-xl font-bold text-sm transition-all">Easy Mode (Choices)</button>
                </div>
            </div>

            <!-- This section will be populated by the active plugin -->
            <div id="plugin-settings-container"></div>

            <div class="flex justify-end pt-4 border-t border-slate-700">
                <button onclick="applySettings()" class="bg-blue-600 hover:bg-blue-500 text-white px-6 py-2 rounded-lg font-bold transition-all">Apply & Restart</button>
            </div>
        </div>
    </div>

    <!-- Multiplayer Lobby Modal -->
    <div id="mp-lobby-modal" class="mp-lobby-modal p-4">
        <div class="bg-slate-800 border border-slate-700 w-full max-w-sm rounded-2xl p-6 shadow-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-5">
                <h2 class="text-xl font-bold text-white">Multiplayer</h2>
                <button onclick="closeLobby()" class="text-slate-400 hover:text-white">‚úï</button>
            </div>

            <!-- Player name -->
            <div class="mb-4">
                <label class="text-xs text-slate-400 mb-1 block">Your name:</label>
                <input id="mp-name-input" type="text" maxlength="16" placeholder="Player"
                       class="w-full bg-slate-900 border border-slate-600 focus:border-blue-500 rounded-lg px-3 py-2 text-sm font-bold text-white outline-none transition-colors"
                       autocomplete="off" spellcheck="false">
            </div>

            <!-- Create / Join toggle -->
            <div class="grid grid-cols-2 gap-2 mb-5">
                <button id="btn-create-room" onclick="createRoom()" class="py-2 rounded-lg font-bold text-sm bg-blue-600 hover:bg-blue-500 text-white transition-colors">Create Room</button>
                <button id="btn-join-room" onclick="showJoinInput()" class="py-2 rounded-lg font-bold text-sm bg-slate-700 hover:bg-slate-600 text-white transition-colors border border-slate-600">Join Room</button>
            </div>

            <!-- Room code display (host) -->
            <div id="mp-code-display" class="hidden mb-4">
                <p class="text-xs text-slate-400 mb-1">Room code ‚Äî share with friends:</p>
                <div class="flex items-center gap-2">
                    <span id="mp-room-code" class="mp-code flex-1 text-center"></span>
                    <button onclick="copyRoomCode()" id="btn-copy-code" class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-2 rounded-lg text-slate-300 transition-colors whitespace-nowrap">Copy</button>
                    <button onclick="copyRoomLink()" id="btn-copy-link" class="text-xs bg-slate-700 hover:bg-slate-600 px-3 py-2 rounded-lg text-slate-300 transition-colors whitespace-nowrap">Copy Link</button>
                </div>
            </div>

            <!-- Join input (guest) -->
            <div id="mp-join-input" class="hidden mb-4">
                <p class="text-xs text-slate-400 mb-1">Enter room code:</p>
                <div class="flex gap-2">
                    <input id="mp-code-input" type="text" maxlength="6" placeholder="ABCD12"
                           class="flex-1 bg-slate-900 border border-slate-600 focus:border-blue-500 rounded-lg px-3 py-2 text-sm font-mono font-bold text-white outline-none uppercase tracking-widest"
                           autocomplete="off" autocapitalize="characters" spellcheck="false">
                    <button onclick="joinRoom()" class="bg-blue-600 hover:bg-blue-500 text-white px-3 py-2 rounded-lg text-sm font-bold transition-colors">Connect</button>
                </div>
                <p id="mp-join-error" class="hidden text-xs text-red-400 mt-1"></p>
            </div>

            <!-- Status / player list -->
            <div id="mp-status" class="hidden mb-4">
                <p id="mp-status-text" class="text-xs text-slate-400 mb-2"></p>
                <ul id="mp-player-list" class="flex flex-col gap-1"></ul>
            </div>

            <!-- Mode selector + Start (host only) -->
            <div id="mp-host-controls" class="hidden">
                <div class="flex items-center gap-2 mb-4">
                    <span class="text-xs text-slate-400 shrink-0">Mode:</span>
                    <select id="mp-mode-select" class="flex-1 bg-slate-700 border border-slate-600 text-white text-sm rounded-lg px-2 py-1.5 outline-none">
                        <option value="race">Race (first correct wins)</option>
                        <option value="compete">High Score</option>
                        <option value="land-grab">Land Grab</option>
                    </select>
                </div>

                <div class="border-t border-slate-700 pt-4 mb-4">
                    <p class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Answer Style</p>
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <button id="mp-btn-hard" onclick="mpSetGameMode('hard')" class="py-1.5 rounded-lg text-xs font-bold bg-slate-700 border border-slate-600 text-white transition-all">Hard (Type)</button>
                        <button id="mp-btn-easy" onclick="mpSetGameMode('easy')" class="py-1.5 rounded-lg text-xs font-bold bg-slate-700 border border-slate-600 text-white transition-all">Easy (Choices)</button>
                    </div>

                    <p class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Regions</p>
                    <div id="mp-region-toggles" class="flex flex-col gap-1.5"></div>
                </div>

                <button onclick="mpStartGame()" id="btn-mp-start" class="w-full bg-green-600 hover:bg-green-500 text-white py-2.5 rounded-xl font-bold transition-colors">Start Game</button>
            </div>

            <!-- Guest waiting message -->
            <div id="mp-guest-waiting" class="hidden text-center text-sm text-slate-400 py-2">Waiting for host to start the game‚Ä¶</div>
        </div>
    </div>

    <!-- Multiplayer Finish Modal -->
    <div id="mp-finish-modal" class="mp-finish-modal p-4">
        <div class="bg-slate-800 border border-slate-700 rounded-2xl p-6 w-full max-w-sm shadow-2xl">
            <div class="text-4xl text-center mb-2">üèÜ</div>
            <h2 class="text-xl font-bold text-white text-center mb-4" id="mp-finish-title">Game Over</h2>
            <div id="mp-results-list" class="flex flex-col gap-2 mb-5"></div>
            <button id="btn-mp-play-again" onclick="mpPlayAgain()" class="hidden w-full bg-blue-600 hover:bg-blue-500 text-white py-2.5 rounded-xl font-bold transition-colors mb-2">Play Again</button>
            <div class="grid grid-cols-2 gap-2 mt-2">
                <button onclick="mpGoHome()" class="bg-slate-700 hover:bg-slate-600 text-white py-2.5 rounded-xl font-bold transition-colors">Home</button>
                <button onclick="mpViewMap()" class="bg-slate-700 hover:bg-slate-600 text-white py-2.5 rounded-xl font-bold transition-colors">View Map</button>
            </div>
        </div>
    </div>

    <!-- Floating Results button (shown when map is being viewed after MP game) -->
    <button id="mp-results-pill" onclick="mpShowResults()" class="hidden fixed bottom-6 left-1/2 -translate-x-1/2 bg-slate-800 border border-slate-600 text-white text-sm font-bold px-5 py-2.5 rounded-full shadow-xl z-50 hover:bg-slate-700 transition-colors">Results ‚Üí</button>

    <!-- Header UI -->
    <div class="w-full max-w-5xl flex items-center justify-between gap-2 mb-1">
        <div class="flex items-center gap-2">
            <span class="text-xs font-mono text-slate-400"><span id="score" class="font-bold text-green-400">0</span>‚úì <span id="wrong-count" class="font-bold text-red-400">0</span>‚úó <span id="timer" class="text-slate-500 mx-1">0:00</span> <span id="remaining" class="font-bold text-blue-400">0</span> left</span>
        </div>
        <div class="flex items-center gap-1">
            <button onclick="resetGame()" class="text-xs bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded-lg font-bold transition-all">‚Ü∫</button>
            <button onclick="toggleSettings()" class="text-xs bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded-lg border border-slate-600 text-slate-300 transition-colors">‚öôÔ∏è</button>
            <button onclick="goHome()" class="text-xs bg-slate-700 hover:bg-slate-600 px-2 py-1 rounded-lg border border-slate-600 text-slate-300 transition-colors">‚åÇ</button>
        </div>
    </div>
    <p id="active-regions-label" class="hidden text-slate-400 text-xs"></p>

    <!-- Main Quiz View Container -->
    <div id="quiz-view-container" class="relative w-full max-w-5xl flex-1 min-h-0 border border-slate-700 shadow-2xl overflow-hidden">
        <!-- The plugin will render its view here. -->
    </div>

    <!-- Interaction Area -->
    <div class="w-full max-w-5xl mt-1">
        <div id="input-area" class="w-full relative">
            <input type="text" id="answer-input" placeholder=""
                   class="w-full bg-slate-800 border-2 border-slate-700 focus:border-blue-500 rounded-xl px-3 py-2 pr-16 text-sm sm:text-base font-bold text-white outline-none transition-all"
                   autocomplete="off" autocapitalize="none" autocorrect="off" spellcheck="false">
            <button onclick="showHint()" id="hint-btn" class="absolute right-2 top-1/2 -translate-y-1/2 text-xs bg-amber-600/20 text-amber-400 border border-amber-600/40 hover:bg-amber-600/40 px-2 py-1 rounded-lg font-bold transition-all">Hint</button>
        </div>

        <!-- Options Container (hidden by default, shown on hint or in Easy Mode) -->
        <div id="options-grid" class="hidden w-full grid grid-cols-2 md:grid-cols-4 gap-3 mt-4">
            <!-- Injected by JS -->
        </div>
    </div>

    <script src="utils.js"></script>
    <script src="registry.js"></script>
    <script src="plugins/geo-quiz.js"></script>
    <script src="settings.js"></script>
    <script src="scores.js"></script>
    <script src="quiz.js"></script>
    <script src="modes/solo.js"></script>
    <script src="modes/race.js"></script>
    <script src="modes/compete.js"></script>
    <script src="modes/land-grab.js"></script>
    <script src="mp/net.js"></script>
    <script src="app.js"></script>
    <script>
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js');
        }
    </script>
</body>
</html>
